{%- assign _tag_min_size = 1 -%}
{%- assign _tag_cur_size = 1 -%}

{%- assign _post_tags = site.posts | map: "tags" | join: "," | split: "," | uniq -%}
{%- assign _writeup_tags = site.writeups | map: "tags" | join: "," | split: "," | uniq -%}
{%- assign _all_tags = _post_tags | concat: _writeup_tags | uniq | sort -%}

{%- assign _tags = _all_tags | sort -%}

{%- for _tag in _tags -%}
  {%- assign _tag_cur_size = site.posts | where_exp: "post", "post.tags contains _tag" | size | plus: site.writeups | where_exp: "writeup", "writeup.tags contains _tag" | size -%}
  {%- if _tag_cur_size > _tag_max_size -%}
    {%- assign _tag_max_size =  _tag_cur_size -%}
  {%- endif -%}
  {%- if _tag_cur_size < _tag_min_size -%}
    {%- assign _tag_min_size = _tag_cur_size -%}
  {%- endif -%}
{%- endfor -%}

{%- assign _tag_gap_size =  _tag_max_size | minus: _tag_min_size | plus: 1 | divided_by: 4 -%}
{%- if _tag_gap_size < 1 -%}
  {%- assign _tag_gap_size = 1 -%}
{%- endif -%}

<div class="site-tags js-tags">
  <ul class="menu">
    <li>
      <button type="button" class="button button--secondary button--pill tag-button tag-button--all" data-encode="">
        Show All<div class="tag-button__count">{{ site.posts | size | plus: site.writeups | size }}</div>
      </button>
    </li>
    {%- for _tag in _tags -%}
      {%- assign _tag_cur_size = site.posts | where_exp: "post", "post.tags contains _tag" | size | plus: site.writeups | where_exp: "writeup", "writeup.tags contains _tag" | size -%}
      {%- assign _tag_min_1 = _tag_min_size -%}
      {%- assign _tag_max_1 = _tag_min_1 | plus: _tag_gap_size -%}
      {%- assign _tag_min_2 = _tag_max_1 -%}
      {%- assign _tag_max_2 = _tag_min_2 | plus: _tag_gap_size -%}
      {%- assign _tag_min_3 = _tag_max_2 -%}
      {%- assign _tag_max
